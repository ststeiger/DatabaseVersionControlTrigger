
-- Enable CLR if needed 
EXECUTE sp_configure 'clr enabled', 1; 
RECONFIGURE; 
GO


DECLARE @sql nvarchar(MAX); 
SELECT -- sch.name, o.name, asm.name, am.assembly_class, am.assembly_method 
	@sql = COALESCE(@sql, N'') + N'DROP ' + CASE WHEN o.type IN ('P','PC')  THEN 'PROCEDURE' ELSE 'FUNCTION' END + ' ' +  + QUOTENAME(sch.name) + '.' + QUOTENAME(o.name) + '; ' + NCHAR(13) + NCHAR(10) 
FROM sys.assembly_modules AS am 
INNER JOIN sys.objects AS o ON o.object_id = am.object_id 
INNER JOIN sys.schemas AS sch ON sch.schema_id= o.schema_id 
INNER JOIN sys.assemblies AS asm ON asm.assembly_id = am.assembly_id 
WHERE asm.name = 'CorEncryption'; 
-- WHERE asm.name = 'ClrFunctionsLibrary' 
;

-- SELECT @sql 
EXECUTE(@sql); 


GO 


DECLARE @sql nvarchar(MAX); 

SELECT -- ta.hash AS AssemblyHash, ta.description, asm.name 
	@sql = COALESCE(@sql, N'') + N'EXEC sp_drop_trusted_assembly ' + N'0x' + CONVERT(nvarchar(MAX), ta.hash, 2) + '; '
FROM sys.trusted_assemblies AS ta
INNER JOIN sys.assemblies AS asm ON asm.name = ta.description 
WHERE asm.name = 'CorEncryption' 

-- SELECT @sql 
EXECUTE(@sql); 


GO


IF EXISTS (SELECT 1 FROM sys.assemblies WHERE name = N'CorEncryption') 
BEGIN
    EXEC('DROP ASSEMBLY CorEncryption; '); 
END


GO 



EXEC sp_add_trusted_assembly 0x910E6F0C448799AFA3689464E9758C322A598C1AE0B03A92BC368CA46CF8F94510DD9CA25D7A5A37D31B1DC607AAD03C6159E42FB5E885FDBE65BF191E684D49, N'CorEncryption'; 
-- EXEC sp_drop_trusted_assembly 0x910E6F0C448799AFA3689464E9758C322A598C1AE0B03A92BC368CA46CF8F94510DD9CA25D7A5A37D31B1DC607AAD03C6159E42FB5E885FDBE65BF191E684D49; 


-- Create the assembly: 
CREATE ASSEMBLY CorEncryption 
-- FROM N'D:\stefan.steiger\Documents\Visual Studio 2022\github\DatabaseVersionControlTrigger\CreateTrustedAssemblyHash\bin\Debug\net8.0\CorEncryption.dll' 
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030076E854940000000000000000E00022200B013000002800000006000000000000F247000000200000006000000000001000200000000200000400000000000000040000000000000000A0000000020000000000000300408500001000001000000000100000100000000000001000000000000000000000009E4700004F000000006000009803000000000000000000000000000000000000008000000C000000D0460000380000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000F8270000002000000028000000020000000000000000000000000000200000602E72737263000000980300000060000000040000002A0000000000000000000000000000400000402E72656C6F6300000C0000000080000000020000002E00000000000000000000000000004000004200000000000000000000000000000000D24700000000000048000000020005008C2C0000441A000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B3002006C00000001000011000F00281100000A0B072C087E1200000A0C2B560F00281300000A7E1400000A281500000A0D092C0D7E1400000A731600000A0C2B34140A000F00281300000A28130000060A00DE18130400720100007011046F1700000A281800000A0A00DE0006731600000A0C2B00082A011000000000380011490018150000011B3002006C00000001000011000F00281100000A0B072C087E1200000A0C2B560F00281300000A7E1400000A281500000A0D092C0D7E1400000A731600000A0C2B34140A000F00281300000A28120000060A00DE18130400720100007011046F1700000A281800000A0A00DE0006731600000A0C2B00082A01100000000038001149001815000001133004009B00000002000011000F00281900000A2D1B0F01281900000A2D120F02281900000A2D090F03281900000A2B01170B072C087E1200000A0C2B670F00281A00000A1732200F01281A00000A1632160F02281A00000A16320C0F03281A00000A16FE042B01170D092C0D720D000070731600000A0C2B2B0F00281A00000A0F01281A00000A0F02281A00000A0F03281A00000A281D0000060A06731600000A0C2B00082A0013300100120000000300001100281E0000060A06731600000A0B2B00072A0000133002003700000004000011000F00281900000A2D0C0F00281A00000A17FE042B01170B072C09168D210000010C2B110F00281A00000A281F0000060A060C2B00082A4E0003026F1B00000A731600000A81140000012A2202281C00000A002A133001000B00000005000011007E010000040A2B00062A00133001000B00000005000011007E020000040A2B00062A22000280010000042A22000280020000042A0000001B3004007A0000000600001100140A281D00000A0B00076F1E00000A00076F1F00000A00076F2000000A0C076F2100000A0D076F2200000A001B8D2100000125167227000070A2251708280F000006A22518282300000AA225197231000070A2251A09280F000006A2282400000A0A0000DE0B072C07076F2500000A00DC0613042B0011042A000001100000020009005E67000B000000001B300400E40000000700001100140A282600000A0B281D00000A0C00140D141304141305141306087E0100000428100000066F2700000A00087E0200000428100000066F2800000A00086F2100000A1305086F2000000A130608110511066F2900000A130700732A00000A1308001108110717732B00000A13090007026F2C00000A1304110911041611048E696F2D00000A0011096F2E00000A0011086F2F00000A0D00DE0D11092C0811096F2500000A00DC00DE0D11082C0811086F2500000A00DC00DE0D11072C0811076F2500000A00DC09280F0000060A00DE0B082C07086F2500000A00DC06130A2B00110A2A0134000002006E002C9A000D000000000200610049AA000D000000000200590061BA000D0000000002000F00C2D1000B000000001B300400F40000000800001100140A02283000000A0C082C1100723D0000707253000070733100000A7A282600000A0B281D00000A0D0002281000000613047E01000004281000000613057E020000042810000006130609110511066F3200000A1307001104733300000A1308001108110716732B00000A13090011048E698D28000001130A1109110A16110A8E696F3400000A2607110A6F3500000A0A00DE0D11092C0811096F2500000A00DC00DE0D11082C0811086F2500000A00DC06283000000A16FE01130B110B2C0D06178D290000016F3600000A0A00DE0D11072C0811076F2500000A00DC00DE0B092C07096F2500000A00DC06130C2B00110C2A0134000002006E002795000D000000000200610044A5000D00000000020057007AD1000D0000000002002A00B7E1000B00000000133003004B0000000900001100028E69733700000A0A160B2B1E000602078F2800000172EC000070283800000A6F3900000A26000717580B07028E691759FE0216FE010C082DD3066F1B00000A6F3A00000A0D2B00092A0013300500440000000A00001100026F3B00000A0A06185B8D280000010B160C2B1A000708185B0208186F3C00000A1F10283D00000A9C000818580C08061759FE0216FE010D092DD90713042B0011042A5672F20000708001000004727501007080020000042A00001B300500AB0000000B0000110072B70100700A02283000000A0B072C0800060C3890000000283E00000A0D00283F00000A130400091104282600000A7E030000046F2C00000A6F4000000A6F2700000A0009186F4100000A00096F4200000A13050002284300000A1306282600000A110511061611068E696F4400000A6F3500000A0A00DE0D11052C0811056F2500000A00DC00DE0D11042C0811046F2500000A00DC00DE0B092C07096F2500000A00DC060C2B00082A000128000002005500257A000D0000000002002700638A000D0000000002001F007B9A000B000000001B300400840000000C0000110072B70100700A283E00000A0B00283F00000A0C000708282600000A7E030000046F2C00000A6F4000000A6F2700000A0007186F4100000A00076F4500000A0D282600000A026F2C00000A13040911041611048E696F4400000A284600000A0A00DE0B082C07086F2500000A00DC00DE0B072C07076F2500000A00DC0613052B0011052A011C0000020014004F63000B0000000002000D006471000B000000001B300400720000000D00001100140A283E00000A0B00076F1E00000A00076F1F00000A00076F2000000A0C076F2100000A0D1B8D2100000125167227000070A2251708280F000006A22518282300000AA225197231000070A2251A09280F000006A2282400000A0A00DE0B072C07076F2500000A00DC0613042B0011042A00000110000002000900565F000B000000001B300200410000000E0000110072B70100700A282600000A026F2C00000A0B283F00000A0C0008076F4000000A0D09284600000A0A140D00DE0B082C07086F2500000A00DC0613042B0011042A0000000110000002001900152E000B000000002E72B901007080030000042A3A007E0A000004026F4700000A002A00133004002E0000000F000011001A8D280000010A7E0A000004066F4700000A000616284800000A20FFFFFF7F5F0B02070302595D580C2B00082A000013300400460000001000001100028E6917590A2B3100720702007002068F29000001284900000A284A00000A0B072C11000203930C02030206939D0206089D2B10000617590A0616FE0416FE010D092DC42A000013300400560000001100001100028E690A720702007002168F29000001284900000A284A00000A16FE010B072C090216032819000006007207020070020617598F29000001284900000A284A00000A16FE010C082C0B02061759032819000006002A0000133004002E0000001200001100028E6917590A2B1C000306910617585D0B0206930C02060207939D0207089D000617590A0616FE020D092DDC2A000013300400430000001300001100026F4B00000A0A068E6917590B2B1C000307910717585D0C0607930D06070608939D0608099D000717590B0716FE02130411042DDA06734C00000A13052B0011052A00133004006A01000014000011000217FE04130411042C10726302007072AB020070734D00000A7A028D280000010A0628170000060002733700000A0B0316FE02130511052C3C001613062B2A0772B902007006076F4E00000A9172B9020070283B00000A5D284F00000A6F5000000A26110617581306110603FE04130711072DCB000416FE02130811082C3C001613092B2A0772E702007006076F4E00000A9172E7020070283B00000A5D284F00000A6F5000000A26110917581309110904FE04130A110A2DCB000516FE02130B110B2C3C0016130C2B2A0772FB02007006076F4E00000A9172FB020070283B00000A5D284F00000A6F5000000A26110C1758130C110C05FE04130D110D2DCB00076F4E00000A0C08130E2B280007720702007006110E917207020070283B00000A5D284F00000A6F5000000A2600110E1758130E110E02FE04130F110F2DCD076F1B00000A6F4B00000A0D0906281B000006000906281A0000060009734C00000A13102B0011102A0000133004000F00000005000011001E171717281D0000060A2B00062A0013300300260000001500001100028D210000010A160B2B0C0607281E000006A20717580B0702FE040C082DEC060D2B00092A8E007223030070282300000A1F0A281F000006285100000A281800000A285200000A002A2E735300000A800A0000042A000042534A4201000100000000000C00000076342E302E33303331390000000005006C000000A0070000237E00000C0800003808000023537472696E67730000000044100000540300002355530098130000100000002347554944000000A81300009C06000023426C6F620000000000000002000001571D02000900000000FA0133001600000100000030000000050000000A00000021000000250000005300000006000000150000001500000001000000020000000000F50301000000000006003F02E7050600BE02E70506005E0198050F00070600000600860173040600220273040600EE0173040600A502730406005F02730406008A02730406009D01730406007201C80506005001C8050600D10173040600B80108030600EE062C040A000D020F050A0093000F050A0078020F050A00500316060600A3042C040A00010016060600F80055060600C405FE070600FF023A0706005904FE0706001F04280006001204FE070600DF043A0706003600FE0706001200FE070600C604FE07060088032C0406003304FE070600F5062C04060004012C040600250428000600D000FE07060085042C040600DE022C040600C1042C04060019072C0406004604FE070600E100FE0706005505FE070600ED042C0406009B042C04060010012C04000000001F000000000001000100010010006806AD04410001000100800110003200AD04410001000800810110003C00AD04410003001200800110003D05AD044100040017001100F80730001100400030001100C60730005180820630005180910630005180B60630005180A00630005180320530005180AD0630003100EC038603502000000000960011078B030100D82000000000960009078B0303006021000000009600A200920305000822000000009600B3009F0309002822000000009600AB05A40309006B220000000091006907AB030A007F220000000086186B0506000C008822000000009600E10772000C00A0220000000096005E0072000C00B722000000009600E807F3010C00C0220000000096006400F3010D00CC22000000009600D50772000E0064230000000096001107B3030E0088240000000096000107B3030F00BC250000000096006D0369011000142600000000960087074D01110064260000000091187105B80312007C260000000096000107B30312005C270000000096000307B30313000828000000009600D5077200140098280000000096009903B3031400F8280000000091187105B803150004290000000091003706BC03150014290000000091003507C20316005029000000009100FA04C8031800A429000000009100CD06D1031B00082A0000000091007A07D1031D00442A0000000091004203D9031F00942A000000009600A200E00321000C2C000000009600B30072002500282C000000009600AF05E80325005A2C0000000093002107B80326007E2C0000000091187105B8032600000000000000000001002F07000000000000000001002F0700000100BD03000002002E0100000300C206000004004006000001006A0400000100C40302000200710700000100EF07000001006A00000001005107000001005E07000001002607000001008203000001004607000001004607000001004607000001002B0600000100ED0200000200F60200000100B007000002007407000003002B0600000100B007000002002B0600000100B007000002002B06000001002F07000002002B0600000100BD03000002002E0100000300C206000004004006000001006A0409006B05010011006B05060019006B050A0029006B05100031006B05100039006B05100041006B05100049006B05100051006B05100059006B05100061006B05150069006B05100071006B05100079006B05100089006B05060099006B050600A10007042400A1000D042800A100E3022C0009012F08300009011B083300A1006B051000A900EC002C000901E7063900B10007042400B100E302470081005A032C0081006B050600C100430168001101D5070600110153000600110145006D001101B6076D001101BB0406001901220172000901E706760021013B010600C900160093001101BE07980011014C009800110188059E00D9006B050600E1006B05A700C9003706B30029014A01B900E100C8030600D9009C076D0009012708DA0039016B05DF00110178059E00D9006B05980029018700E500C9006303ED0009015404F300E9006B05010041015A030101E9008C00060109012A052C000901B203470009018F0316015101DC021C01F10043013001F900430135015901A6033A011101C7004101110178054801510122034D01D100D803530111018805480151013303690169013706980071010A008C0149015A032C0009014C069A010901A407B60109016B05BB0179016B05DF00E900B203470009017806D801E9008C00DD0109016E04EC0181011801F30101016B0506000E00100001020E0014002E020E0018005D020E001C0070020E00200097020E002400F20220007B00CF042400830075062E000B00EE032E001300F7032E001B0016042E0023001F042E002B0032042E00330032042E003B0032042E0043001F042E004B0038042E00530032042E005B0032042E00630050042E006B007A042E007300870440007B00CF0460007B00800564008300750680007B008005A0007B0031061A003F004B00510059005D007C00C100F9000C0122015C016F017A01850193019F01A501AC01C101E301048000000100000000000000000000000000AD040000040000000000000000000000F8017E0000000000040000000000000000000000F801720000000000000000000053716C496E74333200546F496E743332004D4435006765745F55544638003C4D6F64756C653E0053797374656D2E494F0041455300547269706C6544455300735F4956006765745F4956007365745F49560047656E6572617465495600476574495600536574495600696E70757449560053797374656D2E44617461006D73636F726C6962005265616400417070656E6400446174614163636573734B696E640047656E657261746550617373776F72640047656E6572617465436F7250617373776F7264007365745F4D6F64650043727970746F53747265616D4D6F6465004369706865724D6F6465006765745F4D6573736167650049456E756D657261626C650049446973706F7361626C6500436F6E736F6C650057726974654C696E65006765745F4E65774C696E65006E756D55707065726361736500446973706F73650043726561746500577269746500477569644174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C6541747472696275746500417373656D626C7954726164656D61726B417474726962757465005461726765744672616D65776F726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E4174747269627574650053716C46756E6374696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F647563744174747269627574650053716C466163657441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C69747941747472696275746500546F42797465006765745F56616C7565006D696E56616C7565006D617856616C756500456E636F64696E670053797374656D2E52756E74696D652E56657273696F6E696E670046726F6D426173653634537472696E6700546F426173653634537472696E670053687566666C65537472696E670053716C537472696E6700546F537472696E6700476574537472696E6700427974654172726179546F486578537472696E6700737472486578537472696E6700537562737472696E670047656E65726174654861736800436F6D7075746548617368006765745F4C656E677468006C656E677468006F626A00466C75736846696E616C426C6F636B005472616E73666F726D46696E616C426C6F636B00735F676C6F62616C00436F72456E6372797074696F6E2E646C6C006765745F49734E756C6C0043727970746F53747265616D004D656D6F727953747265616D0053797374656D0053796D6D6574726963416C676F726974686D0048617368416C676F726974686D005472696D004943727970746F5472616E73666F726D006E756D004A6F696E0053797374656D2E5265666C656374696F6E00417267756D656E744E756C6C457863657074696F6E00417267756D656E74457863657074696F6E00436F72456E6372797074696F6E00436C656172004368617200524E4743727970746F5365727669636550726F766964657200537472696E674275696C64657200426974436F6E76657274657200537761705769746852616E646F6D4C6574746572004D6963726F736F66742E53716C5365727665722E53657276657200546F4C6F7765720055707065724C6F7765720053656375726550617373776F726447656E657261746F720052616E646F6D4E756D62657247656E657261746F72002E63746F72002E6363746F7200437265617465446563727970746F7200437265617465456E63727970746F720053797374656D2E446961676E6F7374696373007466755F47656E6572617465436F7250617373776F726473004165730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053797374656D2E446174612E53716C54797065730072616E646F6D4279746573004765744279746573006E756D5370656369616C7300436F6E7461696E730053797374656D2E436F6C6C656374696F6E7300537472696E6746756E6374696F6E73006765745F4368617273005570706572636173654368617273004C6F776572636173654368617273005370656369616C436861727300416C6C4368617273004E756D6265724368617273006E756D4E756D6265727300456E7375726546697273744C6173744172654C65747465727300436F6E636174004F626A65637400456E7669726F6E6D656E740044654372797074004465637279707400456E637279707400436F6E76657274005465737400617272496E70757400696E707574004E6578740053797374656D2E5465787400536F757263655465787400737472506C61696E5465787400637970686572546578740046696C6C526F7700707700696E6465780053687566666C65417272617900486578537472696E67546F42797465417272617900546F417272617900546F436861724172726179006172726179006765745F4B6579007365745F4B657900735F73796D6D65747269634B65790047656E65726174654B6579004765744B6579005365744B657900696E7075744B657900735F6B65790053797374656D2E53656375726974792E43727970746F677261706879006F705F457175616C6974790049734E756C6C4F72456D70747900000000000B4500520052003A00200000194500520052003A00200049006E00760061006C00690064000009490056003A002000000B4B00650079003A00200000156300790070006800650072005400650078007400008097630079007000680065007200540065007800740020006D006100790020006E006F007400200062006500200073007400720069006E0067002E0045006D0070007400790020006F00720020004E0055004C004C002C00200062006500630061007500730065002000740068006500730065002000610072006500200069006E007600690064002000760061006C007500650073002E0000055800320000808131006200350035006500630031006400390036006600360033003700610061003700620037003300630033003100370036003500610031003200630032006300380066006200380062003900660036006100650038006200310034003300390036003400370035006100320030006500640031006100380033006400610063000041640034006500330033003800310063006400640033003900640064006200370030006600380035006500390036006400310031006200360036003700650035000001004D7A003600370066003300470048006800640067006100370038006700330067005A00550049005400280036002F0026006E0073003200380039006800730042005F00350054007A0075003600005B410042004300440045004600470048004A004B004D004E005000510052005300540055005600580059005A006100620063006400650066006700680069006A006B006D006E007000710072007300740075007600780079007A000047500061007300730077006F007200640020006C0065006E0067007400680020006D0075007300740020006200650020006100740020006C006500610073007400200031002E00000D6C0065006E00670074006800002D410042004300440045004600470048004A004B004D004E005000510052005300540055005600580059005A0000133100320033003400350036003700380039000027210040002300240025002A00280029002D005F003D002B005B005D007B007D003A003F002C00012F470065006E006500720061007400650064002000500061007300730077006F007200640073003A0020000D000A000000A0AB350EA0F53149B82437C9881C887E00042001010803200001052001011111042001010E04200101020907050E02115102125503200002030611510320000E02060E050002020E0E0500020E0E0E0707040E02115102032000080507020E11510707031D0E02125D0307010E0A07050E12611D051D050E04000012610420001D050300000E0500010E1D0E16070B0E126512611D051D051D051D051269126D12710E0400001265052001011D0508200212691D051D050B20030112809512691180990520011D050E072003011D05080818070D0E12650212611D051D051D051269126D12711D05020E040001020E052002010E0E072003081D0508080520010E1D050520010E1D03070704127508020E0420010E0E05200112750E090705081D0508021D050520020E0808050002050E080D07070E020E1279127D12691D050400001279040000127D0620011D051D05062001011180B104200012690500011D050E0820031D051D0508080C07060E1279127D12691D050E0500010E1D050A07050E12791D051D050E0A07050E1D05127D1D050E0607031D050808060002081D050806070408020302042001020E050703080202060704080803020907061D03080803020E0420001D03052001011D031607111D051275081D030202080202080202080208020E04200103080520011275030807041D0E08021D0E0600020E0E1D0E040001010E08B77A5C561934E0892C410042004300440045004600470048004A004B004D004E005000510052005300540055005600580059005A002E6100620063006400650066006700680069006A006B006D006E007000710072007300740075007600780079007A001231003200330034003500360037003800390026210040002300240025002A00280029002D005F003D002B005B005D007B007D003A003F002C005A410042004300440045004600470048004A004B004D004E005000510052005300540055005600580059005A006100620063006400650066006700680069006A006B006D006E007000710072007300740075007600780079007A008092410042004300440045004600470048004A004B004D004E005000510052005300540055005600580059005A006100620063006400650066006700680069006A006B006D006E007000710072007300740075007600780079007A00310032003300340035003600370038003900210040002300240025002A00280029002D005F003D002B005B005D007B007D003A003F002C000406128081060001115111510C0004115111591159115911590400001151060001125D1159070002011C1011510400010E0E03000001050001011D05050002080808080003011D03081D05070002011D031D050600020E0E1D050700040E080808080500011D0E080801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000701000000001201000D436F72456E6372797074696F6E000005010000000017010012436F7079726967687420C2A920203230323500002901002430666462333330362D626330352D343064632D396230642D38373836366639643937376400000C010007312E302E302E3000004701001A2E4E45544672616D65776F726B2C56657273696F6E3D76342E300100540E144672616D65776F726B446973706C61794E616D65102E4E4554204672616D65776F726B203480AF010003005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E6973746963015402094973507265636973650180AF010003005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E697374696300540209497350726563697365014301000200540E1146696C6C526F774D6574686F644E616D650746696C6C526F77540E0F5461626C65446566696E6974696F6E107077206E76617263686172284D41582923010002005408074D617853697A65FFFFFFFF54020D497346697865644C656E6774680000000000000000BBF7BC92000000000200000096000000084700000829000000000000000000000000000010000000000000000000000000000000525344534BEE62E64703CE4BAF8D928E30FC6B7301000000443A5C73746566616E2E737465696765725C446F63756D656E74735C56697375616C2053747564696F20323032325C6769746875625C446174616261736556657273696F6E436F6E74726F6C547269676765725C436F72456E6372797074696F6E5C6F626A5C44656275675C436F72456E6372797074696F6E2E70646200C64700000000000000000000E0470000002000000000000000000000000000000000000000000000D2470000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C00000000000000FF25002000100000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000586000003C03000000000000000000003C0334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B0049C020000010053007400720069006E006700460069006C00650049006E0066006F0000007802000001003000300030003000300034006200300000001A000100010043006F006D006D0065006E007400730000000000000022000100010043006F006D00700061006E0079004E0061006D006500000000000000000044000E000100460069006C0065004400650073006300720069007000740069006F006E000000000043006F00720045006E006300720079007000740069006F006E000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E003000000044001200010049006E007400650072006E0061006C004E0061006D006500000043006F00720045006E006300720079007000740069006F006E002E0064006C006C0000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020002000320030003200350000002A00010001004C006500670061006C00540072006100640065006D00610072006B00730000000000000000004C00120001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000043006F00720045006E006300720079007000740069006F006E002E0064006C006C0000003C000E000100500072006F0064007500630074004E0061006D0065000000000043006F00720045006E006300720079007000740069006F006E000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000C000000F43700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 
-- WITH PERMISSION_SET = SAFE 
-- WITH PERMISSION_SET = EXTERNAL_ACCESS 
WITH PERMISSION_SET = UNSAFE 
; 


GO 




-- Create the function with explicit VARCHAR(MAX) return type
CREATE FUNCTION dbo.Encrypt(@input nvarchar(MAX))
    RETURNS nvarchar(MAX) -- Explicit VARCHAR return
    AS EXTERNAL NAME CorEncryption.[CorEncryption.StringFunctions].Encrypt
    -- AS EXTERNAL NAME AssemblyName.[YourNamespace.YourClassName].FunctionName;
;

GO


-- Create the function with explicit VARCHAR(MAX) return type
CREATE FUNCTION dbo.Decrypt(@input nvarchar(MAX))
    RETURNS nvarchar(MAX) -- Explicit VARCHAR return
    AS EXTERNAL NAME CorEncryption.[CorEncryption.StringFunctions].Decrypt
;
GO


CREATE FUNCTION dbo.GeneratePassword(
     @length int 
    ,@numUppercase int 
    ,@numNumbers int 
    ,@numSpecials int 
)
    RETURNS nvarchar(MAX) 
    AS EXTERNAL NAME CorEncryption.[CorEncryption.StringFunctions].GeneratePassword
;
GO


CREATE FUNCTION dbo.GenerateCorPassword()
    RETURNS nvarchar(MAX)
    WITH EXECUTE AS CALLER
    AS EXTERNAL NAME CorEncryption.[CorEncryption.StringFunctions].GenerateCorPassword
;
GO



-- Create the table-valued function
CREATE FUNCTION dbo.tfu_GenerateCorPasswords(@num int) 
    RETURNS TABLE (pw nvarchar(MAX)) 
    AS EXTERNAL NAME CorEncryption.[CorEncryption.StringFunctions].tfu_GenerateCorPasswords 
;
GO


-- SELECT * FROM tfu_GenerateCorPasswords(3); 


GO



SELECT 
	 BE_User 
	,BE_Passwort 
	,t.* 
	,dbo.Decrypt(BE_Passwort) 
	-- ,dbo.Decrypt('test') AS err 
	,dbo.GeneratePassword(8, 1, 1, 1) AS newPW1 
	,dbo.GenerateCorPassword() AS newPW2 
FROM T_Benutzer 

OUTER APPLY 
	(
		SELECT 
			 dbo.Encrypt('test123') AS p1 
			,dbo.Encrypt(BE_User) AS p2
			,dbo.Encrypt(LOWER(BE_User)) AS p3 
			,dbo.Encrypt(BE_Email) AS p4 
			,dbo.Encrypt(LOWER(BE_Email)) AS p5 
	) AS t 

WHERE BE_User = 'administrator' 
